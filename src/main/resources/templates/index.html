<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Split Tracker</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <div class="logo"> ExpenseSplit</div>
                <ul class="nav-links">
                    <li><a href="/" class="active">Dashboard</a></li>
                    <li><a href="/users">Users</a></li>
                    <li><a href="/groups">Groups</a></li>
                    <li><a href="/expenses">Expenses</a></li>
                    <li><a href="/balances">Balances</a></li>
                    <li>
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-outline btn-sm" style="color: var(--text-secondary); border: none; background: none;">
                                Logout
                            </button>
                        </form>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <h1 class="section-title">Expense Split Dashboard</h1>
            
            <!-- Alert Container -->
            <div id="alertContainer"></div>
            
            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" th:text="${totalUsers ?: '0'}">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" th:text="${totalGroups ?: '0'}">0</div>
                    <div class="stat-label">Total Groups</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" th:text="${totalExpenses ?: '0'}">0</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h2 class="card-title">Quick Actions</h2>
                <div class="quick-actions">
                    <a href="/users" class="action-btn">
                        <div class="action-icon">üë•</div>
                        <span>Manage Users</span>
                    </a>
                    <a href="/groups" class="action-btn">
                        <div class="action-icon">üè†</div>
                        <span>Manage Groups</span>
                    </a>
                    <a href="/expenses" class="action-btn">
                        <div class="action-icon">üí∞</div>
                        <span>Manage Expenses</span>
                    </a>
                    <a href="/balances" class="action-btn">
                        <div class="action-icon">‚öñÔ∏è</div>
                        <span>View Balances</span>
                    </a>
                </div>
            </div>

            <!-- Quick Create Forms -->
            <div class="row">
                <!-- Quick Add User -->
                <div class="col-4">
                    <div class="card">
                        <h3 class="card-title">Quick Add User</h3>
                        <form id="quickUserForm">
                            <div class="form-group">
                                <input type="text" class="form-control" id="quickUserName" placeholder="Full Name" required>
                            </div>
                            <div class="form-group">
                                <input type="email" class="form-control" id="quickUserEmail" placeholder="Email Address" required>
                            </div>
                            <div class="form-group">
                                <input type="tel" class="form-control" id="quickUserContact" placeholder="Contact Number">
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">Add User</button>
                        </form>
                    </div>
                </div>

                <!-- Quick Create Group -->
                <div class="col-4">
                    <div class="card">
                        <h3 class="card-title">Quick Create Group</h3>
                        <form id="quickGroupForm">
                            <div class="form-group">
                                <input type="text" class="form-control" id="quickGroupName" placeholder="Group Name" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">Create Group</button>
                        </form>
                    </div>
                </div>

                <!-- Quick Add Expense -->
                <div class="col-4">
                    <div class="card">
                        <h3 class="card-title">Quick Add Expense</h3>
                        <form id="quickExpenseForm">
                            <div class="form-group">
                                <label class="form-label">Group</label>
                                <select class="form-control" id="quickExpenseGroup" required>
                                    <option value="">Select Group</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Paid By</label>
                                <select class="form-control" id="quickExpensePaidBy" required>
                                    <option value="">Select User</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-control" id="quickExpenseDesc" placeholder="Expense description" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount (‚Çπ)</label>
                                <input type="number" class="form-control" id="quickExpenseAmount" placeholder="Amount in rupees" step="0.01" min="0.01" required>
                            </div>
                            <button type="submit" class="btn btn-success btn-sm">Add Expense</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <h2 class="card-title">Recent Activity</h2>
                <div id="recentActivity">
                    <p>Loading recent activity...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 ExpenseSplit Tracker. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadRecentActivity();
            loadGroupsForQuickExpense();
            loadUsersForQuickExpense();
            
            // Quick Add User Form
            document.getElementById('quickUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                quickAddUser();
            });
            
            // Quick Create Group Form
            document.getElementById('quickGroupForm').addEventListener('submit', function(e) {
                e.preventDefault();
                quickCreateGroup();
            });
            
            // Quick Add Expense Form
            document.getElementById('quickExpenseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                quickAddExpense();
            });
        });

        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function loadGroupsForQuickExpense() {
            fetch('/api/groups')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load groups');
                    }
                    return response.json();
                })
                .then(groups => {
                    const groupSelect = document.getElementById('quickExpenseGroup');
                    groupSelect.innerHTML = '<option value="">Select Group</option>';
                    
                    groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.groupId;
                        option.textContent = group.name;
                        groupSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading groups for quick expense:', error);
                    showAlert('Error loading groups. Please try again.');
                });
        }

        function loadUsersForQuickExpense() {
            fetch('/api/users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load users');
                    }
                    return response.json();
                })
                .then(users => {
                    const userSelect = document.getElementById('quickExpensePaidBy');
                    userSelect.innerHTML = '<option value="">Select User</option>';
                    
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.userId;
                        option.textContent = `${user.name} (${user.email})`;
                        userSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading users for quick expense:', error);
                    showAlert('Error loading users. Please try again.');
                });
        }

        function quickAddUser() {
            const name = document.getElementById('quickUserName').value;
            const email = document.getElementById('quickUserEmail').value;
            const contactNo = document.getElementById('quickUserContact').value;
            
            if (!name || !email) {
                showAlert('Please fill all required fields.');
                return;
            }

            const userData = {
                name: name,
                email: email,
                contactNo: contactNo,
                password: "default123" // Default password for quick add
            };

            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.json();
            })
            .then(() => {
                document.getElementById('quickUserForm').reset();
                showAlert('User added successfully!', 'success');
                loadUsersForQuickExpense(); // Refresh user dropdown
                setTimeout(() => location.reload(), 1000); // Reload to update stats
            })
            .catch(error => {
                console.error('Error adding user:', error);
                showAlert('Error adding user: ' + error.message);
            });
        }

        function quickCreateGroup() {
            const name = document.getElementById('quickGroupName').value;
            
            if (!name) {
                showAlert('Please enter a group name.');
                return;
            }

            const groupData = {
                name: name
            };

            fetch('/api/groups', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(groupData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.json();
            })
            .then(() => {
                document.getElementById('quickGroupForm').reset();
                showAlert('Group created successfully!', 'success');
                loadGroupsForQuickExpense(); // Refresh group dropdown
                setTimeout(() => location.reload(), 1000); // Reload to update stats
            })
            .catch(error => {
                console.error('Error creating group:', error);
                showAlert('Error creating group: ' + error.message);
            });
        }

        function quickAddExpense() {
            const groupId = document.getElementById('quickExpenseGroup').value;
            const paidBy = document.getElementById('quickExpensePaidBy').value;
            const description = document.getElementById('quickExpenseDesc').value;
            const amount = document.getElementById('quickExpenseAmount').value;
            
            // Validate all fields
            if (!groupId || !paidBy || !description || !amount) {
                showAlert('Please fill all required fields.');
                return;
            }

            if (parseFloat(amount) <= 0) {
                showAlert('Amount must be greater than 0.');
                return;
            }

            const expenseData = {
                groupId: parseInt(groupId),
                paidBy: parseInt(paidBy),
                amount: parseFloat(amount),
                description: description
            };

            console.log('Sending expense data:', expenseData);

            fetch('/api/expenses', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(expenseData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { 
                        throw new Error(text || 'Failed to create expense');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Expense created successfully:', data);
                document.getElementById('quickExpenseForm').reset();
                showAlert('Expense added successfully!', 'success');
                loadRecentActivity(); // Refresh recent activity
                setTimeout(() => location.reload(), 1000); // Reload to update stats
            })
            .catch(error => {
                console.error('Error creating expense:', error);
                let errorMessage = 'Error creating expense. Please try again.';
                
                // Parse error message for better user feedback
                if (error.message.includes('Group not found')) {
                    errorMessage = 'Selected group not found.';
                } else if (error.message.includes('User not found')) {
                    errorMessage = 'Selected payer not found.';
                } else if (error.message.includes('not a member')) {
                    errorMessage = 'Selected payer is not a member of this group.';
                } else if (error.message.includes('Failed to create expense')) {
                    errorMessage = 'Failed to create expense. Please check if the user is a member of the group.';
                }
                
                showAlert(errorMessage);
            });
        }

        function loadRecentActivity() {
            Promise.all([
                fetch('/api/groups').then(r => r.json()).catch(() => []),
                fetch('/api/expenses').then(r => r.json()).catch(() => [])
            ])
            .then(([groups, expenses]) => {
                const activityDiv = document.getElementById('recentActivity');
                let html = '';
                
                if (expenses && expenses.length > 0) {
                    html += '<h4>Recent Expenses</h4><div class="recent-expenses">';
                    // Get group names for display
                    const groupMap = {};
                    groups.forEach(group => {
                        groupMap[group.groupId] = group.name;
                    });
                    
                    // Get user names for display
                    const userMap = {};
                    fetch('/api/users')
                        .then(r => r.json())
                        .then(users => {
                            users.forEach(user => {
                                userMap[user.userId] = user.name;
                            });
                            
                            expenses.slice(0, 5).forEach(expense => {
                                const groupName = groupMap[expense.groupId] || 'Unknown Group';
                                const paidByName = userMap[expense.paidBy] || 'Unknown User';
                                html += `
                                    <div class="recent-item">
                                        <strong>${expense.description}</strong> - ‚Çπ${expense.amount.toFixed(2)}
                                        <br><small>Paid by: ${paidByName} ‚Ä¢ Group: ${groupName} ‚Ä¢ ${expense.expenseDate ? new Date(expense.expenseDate).toLocaleDateString() : 'N/A'}</small>
                                    </div>
                                `;
                            });
                            
                            html += '</div>';
                            
                            if (groups && groups.length > 0) {
                                html += '<h4>Your Groups</h4><div class="group-list">';
                                groups.slice(0, 3).forEach(group => {
                                    html += `<div class="group-item">${group.name}</div>`;
                                });
                                html += '</div>';
                            }
                            
                            activityDiv.innerHTML = html;
                        })
                        .catch(error => {
                            console.error('Error loading users for activity:', error);
                            activityDiv.innerHTML = '<p>Error loading recent activity.</p>';
                        });
                    
                } else {
                    html += '<p>No recent expenses found. Add an expense to get started!</p>';
                    
                    if (groups && groups.length > 0) {
                        html += '<h4>Your Groups</h4><div class="group-list">';
                        groups.slice(0, 3).forEach(group => {
                            html += `<div class="group-item">${group.name}</div>`;
                        });
                        html += '</div>';
                    }
                    
                    activityDiv.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error loading activity:', error);
                document.getElementById('recentActivity').innerHTML = '<p>Error loading recent activity.</p>';
            });
        }
    </script>

    <style>
        .recent-expenses {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .recent-item {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }
        
        .recent-item strong {
            color: var(--text-primary);
        }
        
        .recent-item small {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .group-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .group-item {
            padding: 0.5rem 0.75rem;
            background: rgba(37, 99, 235, 0.1);
            border-radius: var(--radius);
            color: var(--primary);
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .col-4 {
                flex: 0 0 100%;
                margin-bottom: 1rem;
            }
        }
    </style>
</body>
</html>